{% extends "base.html" %}
{% from "macros.html" import sentiment_badge, emotion_badge, pagination, empty_state %}

{% block title %}Analysis History - Sentiment Analyzer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Analysis History</h1>
            <p class="mt-2 text-gray-600">View your past sentiment analyses</p>
        </div>
        <a href="{{ url_for('main.analyze') }}"
           class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            New Analysis
        </a>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
        <form method="GET" action="{{ url_for('main.history') }}" class="flex flex-wrap gap-4 items-center">
            <div>
                <label for="sentiment" class="sr-only">Sentiment</label>
                <select name="sentiment" id="sentiment"
                        class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    <option value="">All Sentiments</option>
                    <option value="positive" {% if sentiment_filter == 'positive' %}selected{% endif %}>Positive</option>
                    <option value="negative" {% if sentiment_filter == 'negative' %}selected{% endif %}>Negative</option>
                    <option value="neutral" {% if sentiment_filter == 'neutral' %}selected{% endif %}>Neutral</option>
                </select>
            </div>
            <div>
                <label for="source" class="sr-only">Source</label>
                <select name="source" id="source"
                        class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    <option value="">All Sources</option>
                    <option value="web" {% if source_filter == 'web' %}selected{% endif %}>Web</option>
                    <option value="api" {% if source_filter == 'api' %}selected{% endif %}>API</option>
                    <option value="batch" {% if source_filter == 'batch' %}selected{% endif %}>Batch</option>
                </select>
            </div>
            <button type="submit"
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                Filter
            </button>
            {% if sentiment_filter or source_filter %}
            <a href="{{ url_for('main.history') }}"
               class="text-gray-500 hover:text-gray-700 text-sm">
                Clear filters
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Results -->
    {% if analyses %}
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="divide-y divide-gray-200">
            {% for analysis in analyses %}
            <div class="p-6 hover:bg-gray-50 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0 mr-4">
                        <a href="{{ url_for('main.analysis_detail', analysis_id=analysis.id) }}"
                           class="text-gray-900 hover:text-blue-600 block">
                            <p class="text-sm line-clamp-2">
                                {{ analysis.input_text[:200] }}{% if analysis.input_text|length > 200 %}...{% endif %}
                            </p>
                        </a>
                        <div class="mt-3 flex flex-wrap items-center gap-2">
                            {{ sentiment_badge(analysis.sentiment, analysis.confidence, 'sm') }}
                            {% if analysis.primary_emotion %}
                            {{ emotion_badge(analysis.primary_emotion, size='sm') }}
                            {% endif %}
                            <span class="text-xs text-gray-400 px-2 py-1 bg-gray-100 rounded">
                                {{ analysis.source }}
                            </span>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-sm text-gray-500">
                            {{ analysis.created_at.strftime('%b %d, %Y') }}
                        </p>
                        <p class="text-xs text-gray-400">
                            {{ analysis.created_at.strftime('%H:%M') }}
                        </p>
                        <form action="{{ url_for('main.delete_analysis', analysis_id=analysis.id) }}"
                              method="POST" class="mt-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit"
                                    class="text-xs text-red-500 hover:text-red-700"
                                    onclick="return confirm('Delete this analysis?')">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {{ pagination(pagination, 'main.history', sentiment=sentiment_filter, source=source_filter) }}
    </div>
    {% else %}
    {{ empty_state(
        'No analyses found',
        'Start analyzing text to see your history here.',
        '<svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        url_for('main.analyze'),
        'Analyze Text'
    ) }}
    {% endif %}
</div>
{% endblock %}
